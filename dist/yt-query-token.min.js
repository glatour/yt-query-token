!function(){function e(e){e._tokens=[new n(0)],e.tokens=[],this.childScopes=[],this.addToken=function(t){if(""!=e._tokens[e._tokens.length-1].key&&""!=e._tokens[e._tokens.length-1].value){var o=new n(e._tokens.length);o.manuallyAdded=t,e._tokens.push(o)}},this.selectNextToken=function(e){for(var n=this.childScopes.length-1;n>=0;n--){var t=this.childScopes[n].selectIfEmpty();if(t)return!0}return!1},this.removeToken=function(n){Bacon.fromArray(e._tokens).filter(function(e){return e!==n.token}).scan([],function(e,n){return e.push(n),e}).digest(e,"_tokens")},this.registerToken=function(e){this.childScopes.push(e)},Bacon.fromBinder(function(n){e.$watchAsProperty("_tokens",!0).onValue(function(t){var o=Bacon.fromArray(t).filter(function(e){return""!==e.key&&""!==e.value&&"&nbsp;"!==e.value});o.map(function(e){return{key:e.key,value:e.value}}).digest(e,"tokens"),o.scan("",function(e,n){return""!==e&&(e+=" and "),e+=n.key+" is "+n.value}).onValue(function(e){n(e)})})}).digest(e,"searchQuery")}function n(e){this.id=e,this.key="",this.value=""}angular.module("app").directive("query",function(){return{restrict:"E",template:'<div class="query-input"><div ng-repeat="token in _tokens"><token token="token"></token></div></div><div>{{searchQuery}}</div>',controller:["$scope",e],scope:{tokens:"="},link:function(e,n,t,e){var o=$(n[0]).children()[0];$(n).asEventStream("click").filter(function(e){return o===e.target}).onValue(function(n){for(var t=e.childScopes.length-1;t>=0;t--){var o=e.childScopes[t].selectIfEmpty();if(o)return!0}return!1})}}})}(),function(){function e(e){e.$watchAsProperty("token.key",!0).filter(function(e){return e.length>0}).filter(function(e){return e.match(/(test|val|1|2|3)$/i)}).onValue(function(n){e.token.value="&nbsp;",e.ui.isValueFocused=!0})}angular.module("app").directive("token",["$timeout",function(n){return{restrict:"E",scope:{token:"="},require:"^query",template:'<div class="query-token"> <div  ng-model="token.key" class="query-token-key input" contenteditable focus-me="ui.isKeyFocused" /><div  ng-show="token.value !== \'\'">:</div> <div  ng-model="token.value" class="query-token-value input" contenteditable focus-me="ui.isValueFocused"/> <div  class="query-token-remove" ng-show="token.value !== \'\' && token.key !== \'\'" ng-click="removeToken()">x</div> </div>',controller:["$scope",e],link:function(e,t,o,i){e.queryCtrl=i,i.registerToken(e),e.ui={isValueFocused:!1},e.selectIfEmpty=function(){return""===e.token.key?(e.ui.isKeyFocused=!0,e.$apply(),!0):""===e.token.value?(e.ui.isValueFocused=!0,e.$apply(),!0):!1},e.removeToken=function(){i.removeToken(e)},n(function(){e.token.manuallyAdded&&$(t).find(".query-token-key")[0].focus()},1),$(t.children(".query-token-value")[0]).asEventStream("focus").onValue(function(e){""===e.target.innerHTML&&(e.target.innerHTML="&nbsp;")}),$(t.find(".query-token-value")[0]).asEventStream("keydown").onValue(function(n){"&nbsp;"===n.target.innerHTML?n.target.innerHTML="":1===n.target.innerHTML.length&&8===n.keyCode?n.target.innerHTML="&nbsp;":(9===n.keyCode&&!n.shiftKey||13===n.keyCode)&&n.target.innerHTML.length>0?(i.addToken(!0),i.selectNextToken(e),n.preventDefault(),n.stopPropagation()):i.addToken(!1)})}}}])}();