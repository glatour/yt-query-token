!function(){function n(n){n._tokens=[new e(0)],n.tokens=[],this.childScopes=[],this.addToken=function(t){if(""!=n._tokens[n._tokens.length-1].key&&""!=n._tokens[n._tokens.length-1].value){var o=new e(n._tokens.length);o.manuallyAdded=t,n._tokens.push(o)}},this.selectNextToken=function(n){for(var e=this.childScopes.length-1;e>=0;e--){var t=this.childScopes[e].selectIfEmpty();if(t)return!0}return!1},this.removeToken=function(e){Bacon.fromArray(n._tokens).filter(function(n){return n!==e.token}).scan([],function(n,e){return n.push(e),n}).digest(n,"_tokens")},this.registerToken=function(n){this.childScopes.push(n)},Bacon.fromBinder(function(e){n.$watchAsProperty("_tokens",!0).onValue(function(t){var o=Bacon.fromArray(t).filter(function(n){return""!==n.key&&""!==n.value&&"&nbsp;"!==n.value});o.map(function(n){return{key:n.key,value:n.value}}).digest(n,"tokens"),o.scan("",function(n,e){return""!==n&&(n+=" and "),n+=e.key+" is "+e.value}).onValue(function(n){e(n)})})}).digest(n,"searchQuery")}function e(n){this.id=n,this.key="",this.value=""}angular.module("yt-query-token",["angular-bacon"]).directive("query",function(){return{restrict:"E",templateUrl:"query.html",controller:["$scope",n],scope:{tokens:"="},link:function(n,e,t,n){var o=$(e[0]).children()[0];$(e).asEventStream("click").filter(function(n){return o===n.target}).onValue(function(e){for(var t=n.childScopes.length-1;t>=0;t--){var o=n.childScopes[t].selectIfEmpty();if(o)return!0}return!1})}}})}(),function(){angular.module("yt-query-token").directive("contenteditable",["$sce",function(n){return{restrict:"A",require:"?ngModel",link:function(e,t,o,r){function i(){var n=t.html();o.stripBr&&"<br>"==n&&(n=""),r.$setViewValue(n)}r&&(r.$render=function(){t.html(n.trustAsHtml(r.$viewValue||""))},t.on("blur keyup change",function(){e.$evalAsync(i)}),i())}}}])}(),function(){angular.module("yt-query-token").directive("focusMe",["$timeout","$parse",function(n,e){return{link:function(t,o,r){var i=e(r.focusMe);t.$watch(i,function(e){e===!0&&n(function(){o[0].focus()})}),o.bind("blur",function(){t.$apply(i.assign(t,!1))})}}}])}(),angular.module("yt-query-token").run(["$templateCache",function(n){n.put("index.html",'<html>\n\n<head>\n  <link rel="stylesheet" href="query.css">\n  <link rel="stylesheet" media="screen" href="https://fontlibrary.org/face/glacial-indifference" type="text/css"/>\n</head>\n\n<body>\n    <div ng-app="app" ng-controller="ctrl">\n\n      <query tokens="myTokens"></query>\n\n      <span ng-repeat="token in tokens">\n          <span style="font-weigth: bold;">{{::token.key}}</span>\n          <span style="font-weigth: bold;">{{::token.value}}</span>\n      </span>\n\n    </div>\n\n    <script src="/bower_components/jquery/dist/jquery.min.js"></script>\n    <script src="/bower_components/bacon/dist/Bacon.js"></script>\n    <script src="/bower_components/angular/angular.js"></script>\n    <script src="/bower_components/angular-bacon/dist/angular-bacon.js"></script>\n\n    <script>\n    angular.module(\'app\', [\'yt-query-token\'])\n        .controller(\'ctrl\', function($scope) {\n            $scope.$watchCollection(\'myTokens\', function (newValue) {\n              console.log(newValue);\n            })\n        });\n    </script>\n    <script src="query.js"></script>\n    <script src="token.js"></script>\n    <script src="content-editable.js"></script>\n    <script src="focus-me.js"></script>\n</body>\n\n</html>\n'),n.put("query.html",'<div class="query-input">\n	<div ng-repeat="token in _tokens">\n		<token token="token"></token>\n	</div>\n</div>\n\n<div>\n	{{searchQuery}}\n</div>'),n.put("token.html",'<div class="query-token">\n	<div 	ng-model="token.key"\n				class="query-token-key input"\n				contenteditable\n				focus-me="ui.isKeyFocused" />\n	<div 	ng-show="token.value !== \'\'">:</div>\n	<div 	ng-model="token.value"\n				class="query-token-value input"\n				contenteditable\n				focus-me="ui.isValueFocused"/>\n	<div 	class="query-token-remove"\n				ng-show="token.value !== \'\' && token.key !== \'\'"\n				ng-click="removeToken()">x</div>\n</div>')}]),function(){function n(n){n.$watchAsProperty("token.key",!0).filter(function(n){return n.length>0}).filter(function(n){return n.match(/(test|val|1|2|3)$/i)}).onValue(function(e){n.token.value="&nbsp;",n.ui.isValueFocused=!0})}angular.module("yt-query-token").directive("token",["$timeout",function(e){return{restrict:"E",scope:{token:"="},require:"^query",templateUrl:"token.html",controller:["$scope",n],link:function(n,t,o,r){n.queryCtrl=r,r.registerToken(n),n.ui={isValueFocused:!1},n.selectIfEmpty=function(){return""===n.token.key?(n.ui.isKeyFocused=!0,n.$apply(),!0):""===n.token.value?(n.ui.isValueFocused=!0,n.$apply(),!0):!1},n.removeToken=function(){r.removeToken(n)},e(function(){n.token.manuallyAdded&&$(t).find(".query-token-key")[0].focus()},1),$(t.children(".query-token-value")[0]).asEventStream("focus").onValue(function(n){""===n.target.innerHTML&&(n.target.innerHTML="&nbsp;")}),$(t.find(".query-token-value")[0]).asEventStream("keydown").onValue(function(e){"&nbsp;"===e.target.innerHTML?e.target.innerHTML="":1===e.target.innerHTML.length&&8===e.keyCode?e.target.innerHTML="&nbsp;":(9===e.keyCode&&!e.shiftKey||13===e.keyCode)&&e.target.innerHTML.length>0?(r.addToken(!0),r.selectNextToken(n),e.preventDefault(),e.stopPropagation()):r.addToken(!1)})}}}])}();